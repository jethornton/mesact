#!/usr/bin/env python3

import sys, os, traceback
from platform import python_version

# disable cache usage must be before any local imports
sys.dont_write_bytecode = True

'''
Depenencies
sudo apt install python3-pyqt5
sudo apt install python3-packaging
sudo apt install zip
'''

VERSION = '2.0.1'
BUILD_DATE = '08/24/2023'

from traceback import StackSummary
from functools import partial

from PyQt5.QtWidgets import QApplication, QMainWindow, QProgressBar
from PyQt5.QtWidgets import QMessageBox
from PyQt5.QtCore import QTimer, QSettings, qVersion
from PyQt5 import uic

from libmesact import startup
from libmesact import boards
from libmesact import downloads
from libmesact import firmware
from libmesact import daughters
from libmesact import documents
from libmesact import dialogs
from libmesact import flash
from libmesact import machine
from libmesact import axes
from libmesact import utilities
from libmesact import flash
from libmesact import check
from libmesact import openini
from libmesact import updateini
from libmesact import buildconfig
from libmesact import sscards
from libmesact import pcinfo
from libmesact import settings
from libmesact import spindle
from libmesact import shutdown
from libmesact import updates
from libmesact import mdi

# testing imports
from libmesact import testing

class MainWindow(QMainWindow):
	def __init__(self):
		super().__init__()
		if os.path.split(sys.argv[0])[0] == '/usr/bin':
			self.lib_path = '/usr/lib/libmesact'
			self.docs_path = '/usr/share/doc/mesact'
			self.installed = True
			uic.loadUi(os.path.join(self.lib_path, 'mesact.ui'), self)
		else:
			srcPath = os.path.split(os.path.realpath(sys.argv[0]))[0]
			self.lib_path = os.path.join(srcPath, 'libmesact')
			self.docs_path = srcPath
			self.installed = False
			uic.loadUi(os.path.join(srcPath, 'mesact.ui'), self)
		stylesheet = os.path.join(self.lib_path, 'mesact.qss')
		with open(stylesheet,'r') as fh:
			self.setStyleSheet(fh.read())

		self.firmware_path = f'{os.path.expanduser("~")}/.local/lib/libmesact'
		self.image_path = f'{os.path.expanduser("~")}/.local/lib/libmesact/boards'
		sys.excepthook = self.excepthook
		self.version = VERSION
		self.emcVersion = '1.1'
		self.setWindowTitle(f'Mesa Configuration Tool - Version {VERSION} - Build Date {BUILD_DATE}')
		self.progressBar = QProgressBar()
		self.statusBar().addPermanentWidget(self.progressBar)
		self.timer=QTimer()
		self.settings = QSettings('mesact', 'mesact')
		self.updateini = updateini.updateini()
		self.loadini = openini.loadini()
		self.boardType = False # eth or pci
		self.password = None
		self.connections()
		startup.setup(self)
		self.show()

	def connections(self):
		# Menu Items
		self.actionNew.triggered.connect(partial(utilities.new_config, self))
		self.actionOpen.triggered.connect(partial(self.loadini.checkini, self))
		self.actionCheck.triggered.connect(partial(check.checkit, self))
		self.actionBuild.triggered.connect(partial(buildconfig.build, self))
		#self.actionTabHelp.triggered.connect(partial(self.help, 0))
		self.actionMesaCT_PC_64_bit.triggered.connect(partial(downloads.downloadAmd64Deb, self))
		self.actionMesaCT_Rpi_32_bit.triggered.connect(partial(downloads.downloadArmhDeb, self))
		self.actionMesaCT_Rpi_64_bit.triggered.connect(partial(downloads.downloadArm64Deb, self))
		self.actionFirmware.triggered.connect(partial(downloads.downloadFirmware, self))
		self.actionDocuments.triggered.connect(partial(documents.openDoc, self))
		self.actionCheckUpdates.triggered.connect(partial(updates.checkUpdates, self))
		self.actionAboutMesaCT.triggered.connect(partial(dialogs.aboutDialog, self))
		#self.actionBoardImages.triggered.connect(partial(updates.boardImages, self))
		self.timer.timeout.connect(partial(downloads.clearProgressBar, self))

		# Machine Tab
		self.configNameLE.textChanged[str].connect(partial(machine.configNameChanged, self))
		self.boardCB.currentIndexChanged.connect(partial(boards.boardChanged, self))
		for i in range(2):
			getattr(self, f'daughterCB_{i}').currentIndexChanged.connect(partial(daughters.changed, self))
		self.checkBoardPB.clicked.connect(partial(flash.checkCard, self))

		'''
		self.enableMesaflashCB.clicked.connect(partial(utilities.firmwareTools, self))
		self.enableMesaflashCB.clicked.connect(partial(settings.update_value, self))
		self.backupCB.clicked.connect(partial(utilities.backup, self))
		'''
		self.default_imperial_pb.clicked.connect(partial(testing.default_imperial, self))
		self.default_metric_pb.clicked.connect(partial(testing.default_metric, self))
		self.set_7i96s_x_pb.clicked.connect(partial(testing.set_7i96s_x, self))
		self.set_7i96s_xyz_pb.clicked.connect(partial(testing.set_7i96s_xyz, self))
		self.set_7i96s_xyyz_pb.clicked.connect(partial(testing.set_7i96s_xyyz, self))
		self.set_7i96s_7i77_pb.clicked.connect(partial(testing.set_7i96s_7i77, self))
		self.set_7i92t_p1_7i76_pb.clicked.connect(partial(testing.set_7i92t_p1_7i76, self))
		self.set_7i92t_p2_7i76_pb.clicked.connect(partial(testing.set_7i92t_p2_7i76, self))
		self.set_7i92t_p2_7i77_pb.clicked.connect(partial(testing.set_7i92t_p2_7i77, self))

		# Settings Tab
		self.minLinJogVelDSB.valueChanged.connect(partial(utilities.unitsChanged, self))
		self.defLinJogVelDSB.valueChanged.connect(partial(utilities.unitsChanged, self))
		self.maxLinJogVelDSB.valueChanged.connect(partial(utilities.unitsChanged, self))
		self.minAngJogVelDSB.valueChanged.connect(partial(utilities.unitsChanged, self))
		self.defAngJogVelDSB.valueChanged.connect(partial(utilities.unitsChanged, self))
		self.maxAngJogVelDSB.valueChanged.connect(partial(utilities.unitsChanged, self))
		self.axisButtonGroup.setExclusive(False)  # Radio buttons are not exclusive
		self.axisButtonGroup.buttonClicked.connect(partial(utilities.axisDisplayChanged, self))
		self.linearUnitsCB.currentIndexChanged.connect(partial(utilities.unitsChanged, self))
		self.trajMaxLinVelDSB.valueChanged.connect(partial(utilities.maxVelChanged, self))

		'''
		#self.frontToolLatheRB.buttonClicked.connect(partial(utilities.axisDisplayChanged, self))
		#self.backToolLatheRB.buttonClicked.connect(partial(utilities.axisDisplayChanged, self))
		#self.foamRB.buttonClicked.connect(partial(utilities.axisDisplayChanged, self))
		'''

		# Firmware Tab
		self.firmwareCB.currentIndexChanged.connect(partial(firmware.firmwareChanged, self))
		self.readhmidPB.clicked.connect(partial(flash.readhmid, self))
		self.readpdPB.clicked.connect(partial(flash.readpd, self))
		self.flashPB.clicked.connect(partial(flash.flashCard, self))
		self.reloadPB.clicked.connect(partial(flash.reloadCard, self))
		self.verifyPB.clicked.connect(partial(flash.verifyFirmware, self))
		self.copyPB.clicked.connect(partial(flash.copyOutput, self))

		# Info Tab

		# Axes Tab
		# for now just do one card
		#j = 0
		for j in range(3):
			for i in range(5):
				getattr(self, f'c{j}_copy_values_{i}').clicked.connect(partial(utilities.copyValues, self))

		for i in range(6):
			for j in range(3): # <-- change when more cards are added
				getattr(self, f'c{j}_axis_{i}').currentIndexChanged.connect(partial(axes.axisChanged, self))
				getattr(self, f'c{j}_scale_{i}').textChanged.connect(partial(axes.updateAxisInfo, self))
				getattr(self, f'c{j}_max_vel_{i}').textChanged.connect(partial(axes.updateAxisInfo, self))
				getattr(self, f'c{j}_max_accel_{i}').textChanged.connect(partial(axes.updateAxisInfo, self))
				getattr(self, f'c{j}_pidDefault_{i}').clicked.connect(partial(axes.pidSetDefault, self))
				getattr(self, f'c{j}_ferrorDefault_{i}').clicked.connect(partial(axes.ferrorSetDefault, self))
				getattr(self, f'c{j}_analogDefault_{i}').clicked.connect(partial(axes.analogSetDefault, self))
				getattr(self, f'c{j}_drive_{i}').currentIndexChanged.connect(partial(axes.driveChanged, self))

		# I/O Tab
		for i in range(3):
			for j in range(32):
				getattr(self, f'c{i}_input_invert_{j}').stateChanged.connect(partial(utilities.inputChanged, self))
				getattr(self, f'c{i}_input_debounce_{j}').stateChanged.connect(partial(utilities.inputChanged, self))

		# Spindle Tab
		self.output_type = '' # hostmot2 output-type
		self.spindleTypeCB.currentIndexChanged.connect(partial(spindle.spindle_type_changed, self))
		self.pidDefault_s.clicked.connect(partial(spindle.spindle_pid_default, self))
		'''
		self.spindleFeedbackCB.currentIndexChanged.connect(partial(utilities.spindleFeedbackChanged, self))
		self.spindleDriveCB.currentIndexChanged.connect(partial(utilities.driveChanged, self))
		self.spindleMinRpm.valueChanged.connect(partial(utilities.spindleSettingsChanged, self))
		self.spindleMaxRpm.valueChanged.connect(partial(utilities.spindleSettingsChanged, self))
		self.spindleMaxAccel.valueChanged.connect(partial(utilities.spindleSettingsChanged, self))
		'''
		# Smart Serial Tab
		self.ssCardCB.currentIndexChanged.connect(partial(sscards.ssCardChanged, self))
		self.ss7i73_keypadCB.currentIndexChanged.connect(partial(sscards.ss7i73Changed, self))
		self.ss7i73lcdCB.currentIndexChanged.connect(partial(sscards.ss7i73Changed, self))
		'''

		# HAL Tab
		self.buildHalPB.clicked.connect(partial(hal.buildHal, self))
		for i in range(6):
			getattr(self, f'halFunctionCB_{i}').currentIndexChanged.connect(partial(hal.functionChanged, self))
		for i in range(4):
			getattr(self, f'functionCountSB_{i}').valueChanged.connect(partial(hal.countChanged, self))

		# Pins Tab
		self.cardPinsPB.clicked.connect(partial(card.getCardPins, self))
		'''
		# PC Tab st_cpu_speed_pb
		self.mb_info_PB.clicked.connect(partial(pcinfo.mbInfo, self))
		self.nic_cpu_speed_pb.clicked.connect(partial(pcinfo.cpuSpeed, self))
		self.nicPB.clicked.connect(partial(pcinfo.nicInfo, self))
		self.ip_nic_PB.clicked.connect(partial(pcinfo.ipInfo, self))
		self.servoThreadTmaxPB.clicked.connect(partial(pcinfo.servoTmax, self))
		self.st_cpu_speed_pb.clicked.connect(partial(pcinfo.cpuSpeed, self))
		self.calcServoPB.clicked.connect(partial(pcinfo.calcServoPercent, self))
		self.readTmaxPB.clicked.connect(partial(pcinfo.readTmax, self))
		self.writeTmaxPB.clicked.connect(partial(pcinfo.writeTmax, self))
		self.calcNicPB.clicked.connect(partial(pcinfo.nicCalc, self))
		self.cpu_info_pb.clicked.connect(partial(pcinfo.cpuInfo, self))
		#self.latencyTestPB.clicked.connect(partial(tools.runLatencyHisogram, self))

		# Options Tab
		self.no_check_firmware_cb.clicked.connect(partial(settings.update_settings, self))
		# check load_config_cb when building only...
		#self.load_config_cb.toggled.connect(partial(settings.update_settings, self))
		#self.checkMesaflashCB.clicked.connect(partial(settings.update_value, self))
		#self.newUserCB.clicked.connect(partial(settings.update_value, self))

		# Options Tab - MDI
		for i in range(10):
			mdi.add_mdi_command_row(self)

		self.addMdiCommandPB.clicked.connect(partial(mdi.add_mdi_command_row, self))

	def changed(self):
		#if isinstance(self.sender(), QComboBox):
		#	if self.sender().currentData():
		self.status_lb.setText('Changed')
		self.actionBuild.setText('Build Config *')

	def resizeEvent(self, event):
		width = self.geometry().width()
		height =  self.geometry().height()
		self.sizeLB.setText(f'{width}x{height}')
		#print("Window has been resized")
		QMainWindow.resizeEvent(self, event)

	def excepthook(self, exc_type, exc_value, tb):
		# extract the stack summary
		summary = traceback.extract_tb(tb)
		for frame_summary in summary:
			filename = frame_summary.filename
			frame_summary.filename = os.path.relpath(filename)

		# rebuild the traceback and build the error message
		msg = f'Mesact Version: {VERSION} Build Date: {BUILD_DATE}\n'
		msg += ''.join(traceback.format_list(StackSummary.from_list(summary)))
		msg += f'{exc_type.__name__}\n'
		msg += f'{exc_value}\n'
		msg += 'Please file an issue at\n'
		msg += 'https://github.com/jethornton/mesact/issues'
		print(msg)
		dialogs.errorMsgOk(msg, 'PROGRAM ERROR' )

	def closeEvent(self, event):
		shutdown.save_settings(self)

app = QApplication(sys.argv)
# check python version
qt_version = qVersion().split('.')
if (sys.version_info.major, sys.version_info.minor) < (3, 6):
	msg = (f'Python 3.6 or newer is required.\nYour Python is {python_version()}')
	dialogs.errorMsgOk(msg, 'Version Error')
	sys.exit()
elif (int(qt_version[0]), int(qt_version[1])) < (5, 15):
	msg = (f'PyQt5 5.15 or newer is required.\nYour PyQt5 is {qVersion()}\n'
	'Try updating python3-pyqt5')
	dialogs.errorMsgOk(msg, 'Version Error')
	sys.exit()

else:
	ex = MainWindow()
sys.exit(app.exec_())


